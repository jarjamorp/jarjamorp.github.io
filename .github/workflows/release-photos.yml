name: Process photos from release

on:
  release:
    types: [published, edited]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive variables
        run: |
          echo "TITLE=${{ github.event.release.name }}" >> $GITHUB_ENV
          echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

          # Pull YYYY-MM-DD from a tag like photos-YYYY-MM-DD-...
          if [[ "${{ github.event.release.tag_name }}" =~ ^photos-([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
            DATE="${BASH_REMATCH[1]}"
          else
            DATE="$(date -u +%F)"
          fi
          echo "DATE=$DATE" >> $GITHUB_ENV

          SAFE_SLUG="$(echo "${{ github.event.release.name }}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g;s/^-+|-+$//g')"
          echo "SAFE_SLUG=$SAFE_SLUG" >> $GITHUB_ENV
          echo "OUTDIR=photos/$DATE-$SAFE_SLUG" >> $GITHUB_ENV

          echo "Derived:"
          echo "  TITLE=$TITLE"
          echo "  TAG=$TAG"
          echo "  DATE=$DATE"
          echo "  OUTDIR=$OUTDIR"

      - name: Wait for release asset (poll)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REL_ID: ${{ github.event.release.id }}
        run: |
          set -e
          for i in {1..30}; do
            ASSET_URL=$(curl -s -H "Authorization: token $GH_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/releases/$REL_ID" \
              | python3 - <<'PY'
import sys, json
data=json.load(sys.stdin)
assets=data.get("assets", [])
print(assets[0]["browser_download_url"] if assets else "")
PY
            )
            if [ -n "$ASSET_URL" ]; then
              echo "ASSET_URL=$ASSET_URL" >> $GITHUB_ENV
              echo "Found asset: $ASSET_URL"
              break
            fi
            echo "No asset yet, sleeping 5s..."
            sleep 5
          done
          test -n "$ASSET_URL" || { echo "ERROR: No assets found on this release."; exit 1; }

      - name: Download ZIP asset
        run: |
          # Repo is public? auth not required, but -L follows redirects.
          curl -L -o photos.zip "$ASSET_URL"
          ls -lh photos.zip

      - name: Unzip photos
        run: |
          mkdir -p incoming
          unzip -q photos.zip -d incoming || { echo "Unzip failed"; exit 2; }
          echo "Unzipped files:"
          ls -l incoming

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pillow pillow-heif || pip install pillow

      - name: Generate gallery
        env:
          TITLE: ${{ env.TITLE }}
          DATE: ${{ env.DATE }}
          OUTDIR: ${{ env.OUTDIR }}
        run: |
          python tools/generate_gallery.py \
            --input incoming \
            --outdir photos \
            --title "$TITLE" \
            --date "$DATE" \
            --max-size 2048 \
            --quality 86

      - name: Commit to main
        run: |
          git config user.name "photo-bot"
          git config user.email "photo-bot@users.noreply.github.com"
          git fetch origin main
          git checkout main
          mkdir -p photos
          cp -r "$OUTDIR" photos/
          git add "$OUTDIR"
          git commit -m "Add gallery: $TITLE ($DATE)" || echo "Nothing to commit"
          git push origin main
