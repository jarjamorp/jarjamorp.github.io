name: Process iOS gallery (marker-triggered, in-place)

on:
  push:
    branches: [ "main" ]
    # Only run when a top-level folder's .from-ios marker is created/updated
    paths:
      - "*/.from-ios"

jobs:
  build:
    if: github.actor != 'github-actions[bot]'  # avoid loops on our own commits
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Derive title/date
        run: |
          echo "TITLE=${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          ts='${{ github.event.head_commit.timestamp }}'
          echo "DATE=$(date -u -d "$ts" +%Y-%m-%d)" >> $GITHUB_ENV
          echo "TITLE=$TITLE"; echo "DATE=$DATE"

      - name: Identify gallery folder from marker
        shell: bash
        run: |
          set -Eeuo pipefail
          CHANGED="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}")"
          echo "$CHANGED" | sed 's/^/CHANGED: /'
          # Find a path ending with '.from-ios' and take its parent dir (top-level)
          GALLERY_DIR="$(awk -F/ '/\.from-ios$/{print $1; exit}' <<< "$CHANGED" || true)"
          if [[ -z "${GALLERY_DIR}" ]]; then echo "No marker found"; exit 1; fi
          if [[ ! -d "${GALLERY_DIR}" ]]; then echo "Folder '${GALLERY_DIR}' not found"; ls -la; exit 1; fi
          echo "Using gallery dir: ${GALLERY_DIR}"
          echo "GALLERY_DIR=${GALLERY_DIR}" >> "$GITHUB_ENV"

      - name: List folder (pre)
        run: ls -lah "$GALLERY_DIR"

      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pillow pillow-heif || pip install pillow

      - name: Generate gallery (in-place)
        env:
          TITLE: ${{ env.TITLE }}
          DATE:  ${{ env.DATE }}
        run: |
          python _tools/generate_gallery.py \
            --input "$GALLERY_DIR" \
            --outdir "$GALLERY_DIR" \
            --title "$TITLE" \
            --date "$DATE" \
            --max-size 2048 \
            --quality 86

      # - name: Regenerate root index.html
      #   run: |
      #     python _tools/generate_site_index.py
      #     test -f index.html || { echo "index.html was not generated"; exit 1; }
          
      - name: Commit processed gallery + index
        run: |
          git config user.name "photo-bot"
          git config user.email "photo-bot@users.noreply.github.com"
          git add "$GALLERY_DIR" index.html
          git commit -m "Process gallery: $TITLE ($DATE) and update index" || echo "Nothing to commit"
          git push origin main
